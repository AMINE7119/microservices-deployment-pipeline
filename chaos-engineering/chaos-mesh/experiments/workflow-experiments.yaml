apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: cascading-failure-workflow
  namespace: chaos-mesh
spec:
  entry: entry
  templates:
    - name: entry
      templateType: Serial
      deadline: 30m
      children:
        - network-partition
        - stress-resources
        - pod-failures
        - recovery-validation
    
    - name: network-partition
      templateType: NetworkChaos
      deadline: 5m
      networkChaos:
        action: partition
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "tier": "backend"
        direction: both
        target:
          mode: all
          selector:
            namespaces:
              - microservices
            labelSelectors:
              "tier": "database"
        duration: "3m"
    
    - name: stress-resources
      templateType: Parallel
      deadline: 10m
      children:
        - cpu-stress
        - memory-stress
    
    - name: cpu-stress
      templateType: StressChaos
      deadline: 5m
      stressChaos:
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "app": "api-gateway"
        stressors:
          cpu:
            workers: 2
            load: 90
        duration: "3m"
    
    - name: memory-stress
      templateType: StressChaos
      deadline: 5m
      stressChaos:
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "app": "user-service"
        stressors:
          memory:
            workers: 2
            size: "512MB"
        duration: "3m"
    
    - name: pod-failures
      templateType: PodChaos
      deadline: 5m
      podChaos:
        action: pod-kill
        mode: random-max-percent
        value: "50"
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "tier": "application"
    
    - name: recovery-validation
      templateType: Suspend
      deadline: 5m
      suspend:
        duration: "5m"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: database-resilience-workflow
  namespace: chaos-mesh
spec:
  entry: database-chaos
  templates:
    - name: database-chaos
      templateType: Serial
      deadline: 20m
      children:
        - kill-primary-db
        - network-latency-db
        - io-chaos-db
        - validate-recovery
    
    - name: kill-primary-db
      templateType: PodChaos
      deadline: 2m
      podChaos:
        action: pod-kill
        mode: fixed
        value: "1"
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "app": "postgresql"
            "role": "primary"
    
    - name: network-latency-db
      templateType: NetworkChaos
      deadline: 5m
      networkChaos:
        action: delay
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "app": "postgresql"
        delay:
          latency: "500ms"
          jitter: "100ms"
        duration: "3m"
    
    - name: io-chaos-db
      templateType: IOChaos
      deadline: 5m
      ioChaos:
        action: latency
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "app": "postgresql"
        volumePath: /var/lib/postgresql/data
        path: "/var/lib/postgresql/data/*"
        delay: "200ms"
        percent: 75
        duration: "3m"
    
    - name: validate-recovery
      templateType: Suspend
      deadline: 5m
      suspend:
        duration: "5m"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: multi-region-failure-workflow
  namespace: chaos-mesh
spec:
  entry: multi-region-chaos
  templates:
    - name: multi-region-chaos
      templateType: Parallel
      deadline: 15m
      children:
        - aws-region-failure
        - gcp-region-failure
        - cross-region-network-chaos
    
    - name: aws-region-failure
      templateType: Serial
      deadline: 10m
      children:
        - aws-pod-chaos
        - aws-network-chaos
    
    - name: aws-pod-chaos
      templateType: PodChaos
      deadline: 5m
      podChaos:
        action: pod-failure
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "cloud": "aws"
            "region": "us-east-1"
        duration: "2m"
    
    - name: aws-network-chaos
      templateType: NetworkChaos
      deadline: 5m
      networkChaos:
        action: loss
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "cloud": "aws"
        loss:
          loss: "50"
        duration: "2m"
    
    - name: gcp-region-failure
      templateType: Serial
      deadline: 10m
      children:
        - gcp-stress-chaos
        - gcp-time-chaos
    
    - name: gcp-stress-chaos
      templateType: StressChaos
      deadline: 5m
      stressChaos:
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "cloud": "gcp"
            "region": "us-central1"
        stressors:
          cpu:
            workers: 4
            load: 95
        duration: "2m"
    
    - name: gcp-time-chaos
      templateType: TimeChaos
      deadline: 5m
      timeChaos:
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "cloud": "gcp"
        timeOffset: "+30m"
        duration: "2m"
    
    - name: cross-region-network-chaos
      templateType: NetworkChaos
      deadline: 10m
      networkChaos:
        action: partition
        mode: all
        selector:
          namespaces:
            - microservices
          labelSelectors:
            "cloud": "aws"
        direction: both
        target:
          mode: all
          selector:
            namespaces:
              - microservices
            labelSelectors:
              "cloud": "gcp"
        duration: "5m"